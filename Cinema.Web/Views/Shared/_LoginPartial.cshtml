<script>
    function isUserSignedIn() {
        return !!localStorage.getItem('accessToken');
    }

    function parseJwt (token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    };

    function getUsername() {
        const token = localStorage.getItem('accessToken');
        if (!token) return null;

        try {
            const payload = parseJwt(token);
            return payload["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"] || null;
        } catch (e) {
            console.error('Ошибка при декодировании токена:', e);
            return null;
        }
    }

    function isUserAdmin() {
        const token = localStorage.getItem('accessToken');
        if (!token) return null;

        try {
            const payload = parseJwt(token);
            const role = payload["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"];
            const roles = Array.isArray(role) ? role : [role];
            return roles.includes('Administrator');
        } catch (e) {
            console.error('Ошибка при декодировании токена:', e);
            return false;
        }
    }

    function logout() {
        const logoutLink = document.getElementById('logout-link');
        if (logoutLink) {
            const logoutUrl = logoutLink.getAttribute('href');
            localStorage.removeItem('accessToken');
            window.location.href = logoutUrl;
        } else {
            console.error('Ошибка: Ссылка на выход не найдена!');
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const authMenu = document.getElementById('auth-menu');
        const guestMenu = document.getElementById('guest-menu');

        if (!authMenu || !guestMenu) return;

        if (isUserSignedIn()) {
            guestMenu.style.display = 'none';
            authMenu.style.display = 'block';

            document.getElementById('username').innerText = "Логин: "+getUsername();

            if (isUserAdmin()) {
                document.getElementById('admin-link').style.display = 'block';
            }
        } else {
            guestMenu.style.display = 'block';
            authMenu.style.display = 'none';
        }
    });
</script>

<ul id="guest-menu" class="nav navbar-nav navbar-right">
    <li><a asp-area="Identity" asp-page="/Account/Login">Вход</a></li>
</ul>
<a id="logout-link" asp-area="Identity" asp-page="/Account/Logout" style="display: none;"></a>
<ul id="auth-menu" class="nav navbar-nav navbar-right" style="display: none;">
    <li><a id="username"></a></li>
    <li id="admin-link" style="display: none;">
        <a asp-area="" asp-controller="Users" asp-action="Index">Пользователи</a>
    </li>
    <li>
        <a asp-area="Identity" asp-page="/Account/Manage/ChangePassword">Сменить пароль</a>
    </li>
    <li>
        <button onclick="logout()" class="btn btn-link navbar-btn navbar-link">Выход</button>
    </li>
</ul>